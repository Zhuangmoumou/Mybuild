name: Build FFmpeg with MPP (ARM64, 静态交叉编译)

on:
  push:
    branches:
      - main
  workflow_dispatch: # 允许手动触发

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      # --- 环境变量设置 ---
      TARGET_ARCH: arm64
      TOOLCHAIN_PREFIX: aarch64-linux-gnu
      # MPP 和 FFmpeg 的安装目录
      MPP_INSTALL_DIR: ${{ github.workspace }}/mpp_install
      FFMPEG_INSTALL_DIR: ${{ github.workspace }}/ffmpeg_install
      OUTPUT_FILENAME: ffmpeg-mpp-arm64-static

    steps:
      - name: 检出主仓库
        uses: actions/checkout@v4

      - name: 设置多架构和安装交叉编译工具链及依赖
        run: |
          # 启用多架构支持
          #sudo dpkg --add-architecture ${{ env.TARGET_ARCH }}
          sudo echo -e '\n# ARM64 architecture sources\n' \
            'deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports noble main restricted universe multiverse\n' \
            'deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports noble-updates main restricted universe multiverse\n' \
            'deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports noble-security main restricted universe multiverse\n' \
            'deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports noble-backports main restricted universe multiverse' | sudo tee -a /etc/apt/sources.list
          sudo apt-get update
          
          # 安装官方 aarch64 交叉编译工具链
          sudo apt-get install -y build-essential git cmake wget \
            gcc-${{ env.TOOLCHAIN_PREFIX }} g++-${{ env.TOOLCHAIN_PREFIX }} \
            ${{ env.TOOLCHAIN_PREFIX }}-pkg-config
            
          # 安装 FFmpeg 依赖的 aarch64 静态开发库
          # 注意：这些库必须是针对 arm64 架构的
          sudo apt-get install -y \
            libx264-dev:${{ env.TARGET_ARCH }} \
            libmp3lame-dev:${{ env.TARGET_ARCH }} \
            libdrm-dev:${{ env.TARGET_ARCH }} \
            libasound2-dev:${{ env.TARGET_ARCH }} \
            libv4l-dev:${{ env.TARGET_ARCH }} \
            zlib1g-dev:${{ env.TARGET_ARCH }} # 确保 zlib 存在

      # QEMU 允许 x86_64 主机透明地运行 ARM64 辅助工具
      - name: 设置 QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all

      # --- 步骤 1: 编译 MPP ---
      - name: 克隆和编译 MPP (静态)
        run: |
          git clone https://github.com/HermanChen/mpp.git
          cd mpp
          
          # 1. 创建 CMake Toolchain 文件 (推荐用于交叉编译)
          cat << EOF > arm64.cmake
          set(CMAKE_SYSTEM_NAME Linux)
          set(CMAKE_SYSTEM_PROCESSOR aarch64)
          set(CMAKE_C_COMPILER ${{ env.TOOLCHAIN_PREFIX }}-gcc)
          set(CMAKE_CXX_COMPILER ${{ env.TOOLCHAIN_PREFIX }}-g++)
          set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
          set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
          set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)
          EOF
          
          # 2. 创建并进入 build 目录
          mkdir build
          cd build
          
          # 3. 运行 CMake 配置
          cmake \
            -DCMAKE_TOOLCHAIN_FILE=../arm64.cmake \
            -DCMAKE_INSTALL_PREFIX=${{ env.MPP_INSTALL_DIR }} \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=OFF \
            -DBUILD_TEST=OFF \
            ..
            
          # 4. 编译和安装
          make -j$(nproc)
          make install
          
          echo "MPP 静态库安装完成于: ${{ env.MPP_INSTALL_DIR }}"

      # --- 步骤 2: 编译 FFmpeg ---
      - name: 克隆和编译 FFmpeg (静态, 链接 MPP)
        run: |
          git clone https://github.com/nyanmisaka/ffmpeg-rockchip.git
          cd ffmpeg-rockchip
          
          # 设置交叉编译器的前缀
          export CC=${{ env.TOOLCHAIN_PREFIX }}-gcc
          export CXX=${{ env.TOOLCHAIN_PREFIX }}-g++
          
          # 运行 configure
          # 1. 使用 --cross-prefix 指定交叉编译器
          # 2. 使用 --extra-cflags 和 --extra-ldflags 链接到静态编译的 MPP 库
          # 3. 移除了 --disable-libx265 (因为没有安装 x265 依赖)
          # 4. 增加了 --disable-opencl (按要求)
          ./configure \
            --prefix=${{ env.FFMPEG_INSTALL_DIR }} \
            --cross-prefix=${{ env.TOOLCHAIN_PREFIX }}- \
            --target-os=linux \
            --arch=${{ env.TARGET_ARCH }} \
            --enable-gpl \
            --enable-version3 \
            --enable-nonfree \
            --enable-static \
            --disable-shared \
            --disable-programs \
            --pkg-config-flags="--static" \
            --enable-libx264 \
            --enable-libmp3lame \
            --enable-rkmpp \
            --enable-rkrga \
            --enable-libdrm \
            --enable-alsa \
            --enable-libv4l2 \
            --disable-opencl \
            --extra-cflags="-I${{ env.MPP_INSTALL_DIR }}/include" \
            --extra-ldflags="-L${{ env.MPP_INSTALL_DIR }}/lib" \
            --extra-libs="-lstdc++ -lm" # 保持用户提供的额外链接库
            
          # 编译和安装
          make -j$(nproc)
          make install
          
          echo "FFmpeg 静态库安装完成于: ${{ env.FFMPEG_INSTALL_DIR }}"

      # --- 步骤 3: 打包和上传 ---
      - name: 打包编译结果
        run: |
          # 验证 FFmpeg 二进制文件信息 (可选，如果编译了 ffmpeg 可执行文件)
          # file ${{ env.FFMPEG_INSTALL_DIR }}/bin/ffmpeg || true
          
          # 打包整个安装目录
          tar czf ${{ env.OUTPUT_FILENAME }}.tar.gz -C ${{ github.workspace }} $(basename ${{ env.FFMPEG_INSTALL_DIR }})

      - name: 上传 artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.OUTPUT_FILENAME }}
          path: ${{ env.OUTPUT_FILENAME }}.tar.gz