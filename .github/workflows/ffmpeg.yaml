name: Build FFmpeg with MPP (ARM64, 完全手动静态交叉编译)

on:
  workflow_dispatch: # 允许手动触发

jobs:
  build:
    runs-on: ubuntu-latest-arm64

    steps:
      - name: 检出主仓库
        uses: actions/checkout@v4
        
      - name: 安装工具链及基础依赖
        run: |
          sudo apt-get update && sudo apt-get install -y \
            build-essential nasm yasm meson cmake pv pkg-config \
            autoconf automake libtool \
            libx264-dev libx265-dev libmp3lame-dev libnuma-dev libasound2-dev libv4l-dev libdrm-dev \
            libssl-dev zlib1g-dev \
            git wget tar gzip
            
      # 创建安装目录
      - name: 创建依赖安装目录
        run: |
          mkdir -p ${{ github.workspace }}/install

      - name: 克隆和编译 MPP
        run: |
          git clone https://github.com/HermanChen/mpp.git
          cd mpp
          cd build
          
          # 3. 运行 CMake 配置
          cmake \
            -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/install \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=OFF \
            -DBUILD_TEST=OFF \
            ..
            
          # 4. 编译和安装
          make -j$(nproc)
          make install
          
          echo "MPP 静态库安装完成于: ${{ github.workspace }}/install"
      
      - name: 克隆和编译 rkrga
        run: |
          cd ${{ github.workspace }}
          git clone -b jellyfin-rga --depth=1 https://github.com/nyanmisaka/rk-mirrors.git rkrga
          cd rkrga
          sed -i 's/shared/static/' meson.build
          meson setup . build --prefix=${{ github.workspace }}/install --libdir=lib --buildtype=release -Dcpp_args=-fpermissive -Dlibdrm=false -Dlibrga_demo=false -Ddefault_library=static
          ninja -C build install
          sed -i 's/Libs: -L${libdir} -lrga -pthread/Libs: -L${libdir} -lrga -pthread -lstdc++ -lm/' ${{ github.workspace }}/install/lib/pkgconfig/librga.pc
          
      # --- 步骤 4: 编译 FFmpeg ---
      - name: 克隆和编译 FFmpeg (静态, 链接所有手动编译的依赖)
        run: |
          git clone https://github.com/nyanmisaka/ffmpeg-rockchip.git
          cd ffmpeg-rockchip
          git checkout 7.1

          ./configure --prefix=${{ github.workspace }}/install/ffmpeg \
          --toolchain=hardened \
          --arch=arm64 \
          --enable-gpl \
          --enable-version3 \
          --enable-nonfree \
          --enable-static \
          --disable-shared \
          --pkg-config-flags="--static" \
          --enable-libx264 \
          --enable-libx265 \
          --enable-libmp3lame \
          --enable-rkmpp \
          --enable-rkrga \
          --enable-libdrm \
          --enable-alsa \
          --enable-libv4l2 \
          --extra-cflags="-I/usr/local/include -I/${{ github.workspace }}/install/include" \
          --extra-ldflags="-L/usr/local/lib/aarch64-linux-gnu -L${{ github.workspace }}/install/lib -L/usr/local/lib -L/usr/lib/aarch64-linux-gnu" \
          --disable-doc
          
          # 编译和安装
          make -j$(nproc) | pv -l -s $(make -n | wc -l)
          make install
          
          #echo "FFmpeg 静态库安装完成于: ${{ env.FFMPEG_INSTALL_DIR }}"

      # --- 步骤 5: 打包和上传 ---
      - name: 打包编译结果
        run: |
          # 打包整个安装目录
          tar czf ffmpeg.tar.gz -C ${{ github.workspace }}/install ffmpeg/

      - name: 上传 artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg.tar.gz
          path: ffmpeg.tar.gz