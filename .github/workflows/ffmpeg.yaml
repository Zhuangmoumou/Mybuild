name: Build FFmpeg with MPP (ARM64, 完全手动静态交叉编译)

on:
  workflow_dispatch: # 允许手动触发

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      # --- 环境变量设置 ---
      TARGET_ARCH: arm64
      TOOLCHAIN_PREFIX: aarch64-linux-gnu
      # 依赖库的安装目录 (x264, LAME)
      DEPS_INSTALL_DIR: ${{ github.workspace }}/deps_install
      # MPP 的安装目录
      MPP_INSTALL_DIR: ${{ github.workspace }}/mpp_install
      # FFmpeg 的最终安装目录
      FFMPEG_INSTALL_DIR: ${{ github.workspace }}/ffmpeg_install
      OUTPUT_FILENAME: ffmpeg-mpp-arm64-static

    steps:
      - name: 检出主仓库
        uses: actions/checkout@v4

      - name: 安装交叉编译工具链及基础依赖
        run: |
          sudo apt-get update
          # 仅安装基础工具链和构建工具
          sudo apt-get install -y build-essential git cmake wget \
            gcc-${{ env.TOOLCHAIN_PREFIX }} g++-${{ env.TOOLCHAIN_PREFIX }} \
            nasm # x264 需要 nasm 汇编器

      # QEMU 允许 x86_64 主机透明地运行 ARM64 辅助工具
      - name: 设置 QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all
          
      # 创建安装目录
      - name: 创建依赖安装目录
        run: |
          mkdir -p ${{ env.DEPS_INSTALL_DIR }}
          mkdir -p ${{ env.MPP_INSTALL_DIR }}

      # --- 步骤 1: 编译 x264 (静态) ---
      - name: 编译 x264 (静态)
        run: |
          git clone https://code.videolan.org/videolan/x264.git
          cd x264
          
          # 配置 x264
          ./configure \
            --prefix=${{ env.DEPS_INSTALL_DIR }} \
            --host=${{ env.TOOLCHAIN_PREFIX }} \
            --enable-static \
            --disable-shared \
            --disable-cli \
            --disable-opencl
            
          make -j$(nproc)
          make install
          echo "x264 静态库安装完成于: ${{ env.DEPS_INSTALL_DIR }}"

      # --- 步骤 2: 编译 LAME (mp3lame, 静态) ---
      - name: 编译 LAME (静态)
        run: |
          # 使用官方 LAME 源码
          wget https://downloads.sourceforge.net/project/lame/lame/3.100/lame-3.100.tar.gz
          tar xzf lame-3.100.tar.gz
          cd lame-3.100
          
          # 配置 LAME
          ./configure \
            --prefix=${{ env.DEPS_INSTALL_DIR }} \
            --host=${{ env.TOOLCHAIN_PREFIX }} \
            --enable-static \
            --disable-shared
            
          make -j$(nproc)
          make install
          echo "LAME 静态库安装完成于: ${{ env.DEPS_INSTALL_DIR }}"

      # --- 步骤 3: 编译 MPP (静态) ---
      - name: 克隆和编译 MPP (静态)
        run: |
          git clone https://github.com/HermanChen/mpp.git
          cd mpp
          
          # 1. 创建 CMake Toolchain 文件 (用于交叉编译)
          cat << EOF > arm64.cmake
          set(CMAKE_SYSTEM_NAME Linux)
          set(CMAKE_SYSTEM_PROCESSOR aarch64)
          set(CMAKE_C_COMPILER ${{ env.TOOLCHAIN_PREFIX }}-gcc)
          set(CMAKE_CXX_COMPILER ${{ env.TOOLCHAIN_PREFIX }}-g++)
          set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
          set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
          set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)
          EOF
          
          # 2. 创建并进入 build 目录
          cd build
          
          # 3. 运行 CMake 配置
          cmake \
            -DCMAKE_TOOLCHAIN_FILE=../arm64.cmake \
            -DCMAKE_INSTALL_PREFIX=${{ env.MPP_INSTALL_DIR }} \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=OFF \
            -DBUILD_TEST=OFF \
            ..
            
          # 4. 编译和安装
          make -j$(nproc)
          make install
          
          echo "MPP 静态库安装完成于: ${{ env.MPP_INSTALL_DIR }}"

      # --- 步骤 4: 编译 FFmpeg ---
      - name: 克隆和编译 FFmpeg (静态, 链接所有手动编译的依赖)
        run: |
          git clone https://github.com/nyanmisaka/ffmpeg-rockchip.git
          cd ffmpeg-rockchip
          
          # 设置交叉编译器的前缀
          export CC=${{ env.TOOLCHAIN_PREFIX }}-gcc
          export CXX=${{ env.TOOLCHAIN_PREFIX }}-g++
          
          # 运行 configure
          # 1. 链接到 DEPS_INSTALL_DIR (x264, LAME) 和 MPP_INSTALL_DIR
          # 2. 移除了 libdrm, alsa, libv4l2 依赖，以确保纯静态编译成功
          ./configure \
            --prefix=${{ env.FFMPEG_INSTALL_DIR }} \
            --cross-prefix=${{ env.TOOLCHAIN_PREFIX }}- \
            --target-os=linux \
            --arch=${{ env.TARGET_ARCH }} \
            --enable-gpl \
            --enable-version3 \
            --enable-nonfree \
            --enable-static \
            --disable-shared \
            --enable-programs \
            --pkg-config-flags="--static" \
            --enable-libx264 \
            --disable-libx265 \
            --enable-libmp3lame \
            --enable-rkmpp \
            --enable-rkrga \
            --disable-libdrm \
            --disable-alsa \
            --disable-libv4l2 \
            --disable-opencl \
            --extra-cflags="-I${{ env.DEPS_INSTALL_DIR }}/include -I${{ env.MPP_INSTALL_DIR }}/include" \
            --extra-ldflags="-L${{ env.DEPS_INSTALL_DIR }}/lib -L${{ env.MPP_INSTALL_DIR }}/lib" \
            --extra-libs="-lstdc++ -lm"
            
          # 编译和安装
          make -j$(nproc)
          make install
          
          echo "FFmpeg 静态库安装完成于: ${{ env.FFMPEG_INSTALL_DIR }}"

      # --- 步骤 5: 打包和上传 ---
      - name: 打包编译结果
        run: |
          # 打包整个安装目录
          tar czf ${{ env.OUTPUT_FILENAME }}.tar.gz -C ${{ github.workspace }} $(basename ${{ env.FFMPEG_INSTALL_DIR }})

      - name: 上传 artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.OUTPUT_FILENAME }}
          path: ${{ env.OUTPUT_FILENAME }}.tar.gz