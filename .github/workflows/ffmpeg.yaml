name: Build Static FFmpeg with RKMpp (ARM64)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    # 定义环境变量
    env:
      # 目标架构
      TARGET_ARCH: aarch64
      # 交叉编译工具链前缀
      TOOLCHAIN_PREFIX: aarch64-linux-gnu
      # 最终安装目录
      INSTALL_DIR: ${{ github.workspace }}/ffmpeg-install
      # MPP 静态库安装目录
      MPP_INSTALL_DIR: ${{ github.workspace }}/mpp-install
      # 外部库（x264, x265等）静态库安装目录
      EXTERNAL_INSTALL_DIR: ${{ github.workspace }}/external-install
      # FFmpeg 源代码仓库
      FFMPEG_REPO: https://github.com/nyanmisaka/ffmpeg-rockchip.git
      # MPP 源代码仓库
      MPP_REPO: https://github.com/HermanChen/mpp.git
      # 静态编译所需的 pkg-config 路径 (合并所有自定义安装路径)
      PKG_CONFIG_PATH: ${{ github.workspace }}/mpp-install/lib/pkgconfig:${{ github.workspace }}/external-install/lib/pkgconfig

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Install Cross-Compilation Toolchain and Dependencies
        run: |
          # 安装 ARM64 交叉编译工具链
          sudo apt update
          sudo apt install -y \
            g++-${{ env.TOOLCHAIN_PREFIX }} \
            gcc-${{ env.TOOLCHAIN_PREFIX }} \
            binutils-${{ env.TOOLCHAIN_PREFIX }} \
            libc6-dev-arm64-cross \
            
          # 安装编译依赖项 (宿主机)
          sudo apt install -y \
            build-essential \
            git \
            cmake \
            pkg-config \
            yasm \
            nasm \
            
          # 确保 pkg-config 能够找到交叉编译的库 (系统路径)
          export PKG_CONFIG_PATH=/usr/lib/${{ env.TOOLCHAIN_PREFIX }}/pkgconfig:/usr/local/lib/${{ env.TOOLCHAIN_PREFIX }}/pkgconfig

      - name: 1. Build and Install Static RKMpp
        run: |
          git clone ${{ env.MPP_REPO }} mpp_src
          cd mpp_src
          cd build
          
          # CMake 交叉编译工具链文件
          echo "set(CMAKE_SYSTEM_NAME Linux)" > toolchain.cmake
          echo "set(CMAKE_SYSTEM_PROCESSOR ${{ env.TARGET_ARCH }})" >> toolchain.cmake
          echo "set(CMAKE_C_COMPILER ${{ env.TOOLCHAIN_PREFIX }}-gcc)" >> toolchain.cmake
          echo "set(CMAKE_CXX_COMPILER ${{ env.TOOLCHAIN_PREFIX }}-g++)" >> toolchain.cmake
          
          # 编译 RKMpp 静态库
          cmake .. \
            -DCMAKE_TOOLCHAIN_FILE=toolchain.cmake \
            -DCMAKE_INSTALL_PREFIX=${{ env.MPP_INSTALL_DIR }} \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=OFF \
            -DBUILD_TEST=OFF
            
          make -j$(nproc)
          make install
          cd ../.. # 返回到工作区根目录
          
      - name: 2. Build and Install Static x264 and x265
        run: |
          # 创建安装目录
          mkdir -p ${{ env.EXTERNAL_INSTALL_DIR }}
          
          # --- 编译 x264 ---
          echo "--- Building x264 ---"
          git clone https://code.videolan.org/videolan/x264.git x264_src
          cd x264_src
          ./configure \
            --prefix=${{ env.EXTERNAL_INSTALL_DIR }} \
            --enable-static \
            --disable-shared \
            --host=${{ env.TOOLCHAIN_PREFIX }} \
            --cross-prefix=${{ env.TOOLCHAIN_PREFIX }}- \
            --enable-pic
          make -j$(nproc)
          make install
          cd ..
          
          # --- 编译 x265 ---
          echo "--- Building x265 ---"
          git clone https://bitbucket.org/multicoreware/x265_git.git x265_src
          cd x265_src
          mkdir build && cd build
          
          # 重新创建 CMake 交叉编译工具链文件 (与 RKMpp 步骤类似)
          echo "set(CMAKE_SYSTEM_NAME Linux)" > toolchain.cmake
          echo "set(CMAKE_SYSTEM_PROCESSOR ${{ env.TARGET_ARCH }})" >> toolchain.cmake
          echo "set(CMAKE_C_COMPILER ${{ env.TOOLCHAIN_PREFIX }}-gcc)" >> toolchain.cmake
          echo "set(CMAKE_CXX_COMPILER ${{ env.TOOLCHAIN_PREFIX }}-g++)" >> toolchain.cmake
          
          # 使用自定义工具链文件编译 x265
          cmake ../source \
            -DCMAKE_TOOLCHAIN_FILE=toolchain.cmake \
            -DCMAKE_INSTALL_PREFIX=${{ env.EXTERNAL_INSTALL_DIR }} \
            -DENABLE_SHARED=OFF \
            -DENABLE_STATIC=ON \
            -DENABLE_CLI=OFF \
            -DENABLE_PIC=ON \
            -DCMAKE_BUILD_TYPE=Release
            
          make -j$(nproc)
          make install
          cd ../.. # 返回到工作区根目录
          
          # 确保 pkg-config 路径包含外部库
          export PKG_CONFIG_PATH=${{ env.PKG_CONFIG_PATH }}

      - name: 3. Build and Install Static FFmpeg
        run: |
          git clone ${{ env.FFMPEG_REPO }} ffmpeg_src
          cd ffmpeg_src
          
          # FFmpeg 静态配置命令
          ./configure \
            --prefix=${{ env.INSTALL_DIR }} \
            --cross-prefix=${{ env.TOOLCHAIN_PREFIX }}- \
            --target-os=linux \
            --arch=${{ env.TARGET_ARCH }} \
            --enable-gpl \
            --enable-version3 \
            --enable-nonfree \
            \
            --enable-static \
            --disable-shared \
            --disable-programs \
            --pkg-config-flags="--static" \
            \
            --enable-libx264 \
            --enable-libx265 \
            --enable-rkmpp \
            \
            --disable-libmp3lame \
            --disable-libdrm \
            --disable-egl \
            --disable-opengles \
            --disable-alsa \
            --disable-libv4l2 \
            --disable-opencl \
            \
            --extra-cflags="-I${{ env.MPP_INSTALL_DIR }}/include -I${{ env.EXTERNAL_INSTALL_DIR }}/include" \
            --extra-ldflags="-L${{ env.MPP_INSTALL_DIR }}/lib -L${{ env.EXTERNAL_INSTALL_DIR }}/lib" \
            --extra-libs="-lstdc++ -lm"
            
          make -j$(nproc)
          make install

      - name: 4. Package the installed FFmpeg
        run: |
          cd ${{ github.workspace }}
          tar -czvf ffmpeg-arm64-static-rkmpp.tar.gz ffmpeg-install

      - name: 5. Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-arm64-static-rkmpp
          path: ${{ github.workspace }}/ffmpeg-arm64-static-rkmpp.tar.gz